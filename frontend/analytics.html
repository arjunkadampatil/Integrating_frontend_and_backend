<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics - EventSphere</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Tailwind CSS -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <!-- AOS Animation Library -->
    <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Floating Background Shapes -->
    <div class="floating-shapes">
        <div class="shape"></div>
        <div class="shape"></div>
        <div class="shape"></div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <img src="assets/logo.svg" alt="EventSphere" class="me-2">
                <span class="fs-4 fw-bold">EventSphere</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="event.html">Events</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="dashboardLink">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="analytics.html">Analytics</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown" id="userMenu">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user me-1"></i>
                            <span id="userName">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end glass-dark">
                            <li><a class="dropdown-item text-light" href="#" id="dashboardMenuItem">Dashboard</a></li>
                            <li><a class="dropdown-item text-light active" href="analytics.html">Analytics</a></li>
                            <li><a class="dropdown-item text-light" href="profile.html">Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-light" href="#" id="logoutLink">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Analytics Container -->
    <div class="dashboard-container">
        <div class="container-fluid px-4 py-5">
            <!-- Header Section -->
            <div class="row mt-5 mb-4">
                <div class="col-12">
                    <div class="glass p-4 rounded-4" data-aos="fade-up">
                        <div class="d-flex align-items-center justify-content-between flex-wrap">
                            <div>
                                <h1 class="h2 fw-bold mb-2">
                                    <i class="fas fa-chart-bar me-3" style="color: #3b82f6;"></i>
                                    Analytics Dashboard
                                </h1>
                                <p class="text-light mb-0">Comprehensive insights and performance metrics</p>
                            </div>
                            <div class="d-flex gap-2">
                                <select class="form-select" id="timeRangeFilter" style="width: auto;">
                                    <option value="7">Last 7 Days</option>
                                    <option value="30" selected>Last 30 Days</option>
                                    <option value="90">Last 3 Months</option>
                                    <option value="365">Last Year</option>
                                </select>
                                <button class="btn btn-secondary" id="exportDataBtn">
                                    <i class="fas fa-download me-2"></i>Export
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Key Metrics Cards -->
            <div class="row g-4 mb-5" id="metricsRow">
                <div class="col-lg-3 col-md-6" data-aos="fade-up" data-aos-delay="100">
                    <div class="stats-card">
                        <i class="fas fa-calendar-alt fa-3x mb-3" style="color: #3b82f6;"></i>
                        <div class="stats-number" id="totalEventsMetric">0</div>
                        <div class="stats-label">Total Events</div>
                        <small class="text-success" id="eventsChange">+0% from last period</small>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6" data-aos="fade-up" data-aos-delay="200">
                    <div class="stats-card">
                        <i class="fas fa-users fa-3x mb-3" style="color: #10b981;"></i>
                        <div class="stats-number" id="totalParticipantsMetric">0</div>
                        <div class="stats-label">Total Participants</div>
                        <small class="text-success" id="participantsChange">+0% from last period</small>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6" data-aos="fade-up" data-aos-delay="300">
                    <div class="stats-card">
                        <i class="fas fa-percentage fa-3x mb-3" style="color: #f59e0b;"></i>
                        <div class="stats-number" id="attendanceRateMetric">0%</div>
                        <div class="stats-label">Avg Attendance Rate</div>
                        <small class="text-success" id="attendanceChange">+0% from last period</small>
                    </div>
                </div>
                
                <div class="col-lg-3 col-md-6" data-aos="fade-up" data-aos-delay="400">
                    <div class="stats-card">
                        <i class="fas fa-trophy fa-3x mb-3" style="color: #8b5cf6;"></i>
                        <div class="stats-number" id="successRateMetric">0%</div>
                        <div class="stats-label">Event Success Rate</div>
                        <small class="text-success" id="successChange">+0% from last period</small>
                    </div>
                </div>
            </div>

            <!-- Charts Row -->
            <div class="row g-4 mb-5">
                <!-- Event Trends Chart -->
                <div class="col-lg-8">
                    <div class="glass p-4 rounded-4" data-aos="fade-up">
                        <div class="d-flex align-items-center justify-content-between mb-4">
                            <h3 class="fw-bold mb-0">
                                <i class="fas fa-line-chart me-2"></i>Event Trends
                            </h3>
                            <div class="btn-group" role="group">
                                <input type="radio" class="btn-check" name="chartType" id="eventsChart" autocomplete="off" checked>
                                <label class="btn btn-outline-primary btn-sm" for="eventsChart">Events</label>
                                
                                <input type="radio" class="btn-check" name="chartType" id="registrationsChart" autocomplete="off">
                                <label class="btn btn-outline-primary btn-sm" for="registrationsChart">Registrations</label>
                                
                                <input type="radio" class="btn-check" name="chartType" id="attendanceChart" autocomplete="off">
                                <label class="btn btn-outline-primary btn-sm" for="attendanceChart">Attendance</label>
                            </div>
                        </div>
                        <div class="chart-container">
                            <canvas id="trendsChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div>
                
                <!-- Event Categories Chart -->
                <div class="col-lg-4">
                    <div class="glass p-4 rounded-4" data-aos="fade-up" data-aos-delay="100">
                        <h3 class="fw-bold mb-4">
                            <i class="fas fa-pie-chart me-2"></i>Event Categories
                        </h3>
                        <div class="chart-container">
                            <canvas id="categoriesChart" width="300" height="300"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Performance Insights -->
            <div class="row g-4 mb-5">
                <!-- Top Performing Events -->
                <div class="col-lg-6">
                    <div class="glass p-4 rounded-4" data-aos="fade-up">
                        <h3 class="fw-bold mb-4">
                            <i class="fas fa-star me-2"></i>Top Performing Events
                        </h3>
                        
                        <!-- Loading Spinner -->
                        <div class="loading-spinner text-center" id="topEventsLoading">
                            <div class="spinner"></div>
                            <p>Loading top events...</p>
                        </div>
                        
                        <!-- Events List -->
                        <div id="topEventsList" style="display: none;">
                            <!-- Top events will be loaded here -->
                        </div>
                        
                        <!-- No Data Message -->
                        <div class="text-center py-4" id="noTopEventsMessage" style="display: none;">
                            <i class="fas fa-chart-line fa-3x mb-3" style="color: #6b7280;"></i>
                            <p class="text-light">No event data available for the selected period</p>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Activity -->
                <div class="col-lg-6">
                    <div class="glass p-4 rounded-4" data-aos="fade-up" data-aos-delay="100">
                        <h3 class="fw-bold mb-4">
                            <i class="fas fa-clock me-2"></i>Recent Activity
                        </h3>
                        
                        <!-- Loading Spinner -->
                        <div class="loading-spinner text-center" id="activityLoading">
                            <div class="spinner"></div>
                            <p>Loading recent activity...</p>
                        </div>
                        
                        <!-- Activity Timeline -->
                        <div id="activityTimeline" style="display: none;">
                            <!-- Activity items will be loaded here -->
                        </div>
                        
                        <!-- No Activity Message -->
                        <div class="text-center py-4" id="noActivityMessage" style="display: none;">
                            <i class="fas fa-history fa-3x mb-3" style="color: #6b7280;"></i>
                            <p class="text-light">No recent activity found</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Event Status Distribution -->
            <div class="row g-4 mb-5">
                <div class="col-12">
                    <div class="glass p-4 rounded-4" data-aos="fade-up">
                        <h3 class="fw-bold mb-4">
                            <i class="fas fa-tasks me-2"></i>Event Status Overview
                        </h3>
                        <div class="row g-3">
                            <div class="col-lg-3 col-md-6">
                                <div class="glass p-3 rounded-3 text-center">
                                    <div class="h2 fw-bold text-warning mb-2" id="pendingEventsCount">0</div>
                                    <div class="text-light">Pending Approval</div>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-warning" id="pendingProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="glass p-3 rounded-3 text-center">
                                    <div class="h2 fw-bold text-success mb-2" id="approvedEventsCount">0</div>
                                    <div class="text-light">Approved</div>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-success" id="approvedProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="glass p-3 rounded-3 text-center">
                                    <div class="h2 fw-bold text-primary mb-2" id="completedEventsCount">0</div>
                                    <div class="text-light">Completed</div>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-primary" id="completedProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-lg-3 col-md-6">
                                <div class="glass p-3 rounded-3 text-center">
                                    <div class="h2 fw-bold text-danger mb-2" id="cancelledEventsCount">0</div>
                                    <div class="text-light">Cancelled</div>
                                    <div class="progress mt-2" style="height: 4px;">
                                        <div class="progress-bar bg-danger" id="cancelledProgress" style="width: 0%"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AOS Animation JS -->
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Custom JS -->
    <script src="config.js"></script>
    <script src="navbar.js"></script>
    
    <script>
        // Initialize AOS
        AOS.init({
            duration: 800,
            easing: 'ease-in-out',
            once: true
        });

        let trendsChart = null;
        let categoriesChart = null;
        let currentTimeRange = 30;

        // Check authentication and load analytics
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('userToken');
            const role = localStorage.getItem('userRole');
            
            if (!token) {
                Utils.showToast('Please login to access analytics.', 'warning');
                window.location.href = 'login.html';
                return;
            }
            
            // Only allow club and admin access to analytics
            if (role !== 'club' && role !== 'admin') {
                Utils.showToast('Access denied. Analytics is only available for clubs and administrators.', 'danger');
                window.location.href = 'index.html';
                return;
            }
            
            // Set dashboard links based on role
            setDashboardLinks(role);
            
            // Load analytics data
            loadAnalyticsData();
            
            // Setup event listeners
            setupEventListeners();
        });

        // Set dashboard links based on user role
        function setDashboardLinks(role) {
            const dashboardLink = document.getElementById('dashboardLink');
            const dashboardMenuItem = document.getElementById('dashboardMenuItem');
            
            let dashboardUrl = 'index.html';
            
            switch(role) {
                case 'club':
                    dashboardUrl = 'club-dashboard.html';
                    break;
                case 'admin':
                    dashboardUrl = 'admin-dashboard.html';
                    break;
            }
            
            if (dashboardLink) dashboardLink.href = dashboardUrl;
            if (dashboardMenuItem) dashboardMenuItem.href = dashboardUrl;
        }

        // Setup event listeners
        function setupEventListeners() {
            // Time range filter
            document.getElementById('timeRangeFilter').addEventListener('change', function() {
                currentTimeRange = parseInt(this.value);
                loadAnalyticsData();
            });
            
            // Chart type toggles
            document.querySelectorAll('input[name="chartType"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.checked) {
                        updateTrendsChart(this.id);
                    }
                });
            });
            
            // Export data
            document.getElementById('exportDataBtn').addEventListener('click', exportAnalyticsData);
        }

        // Load analytics data
        async function loadAnalyticsData() {
            try {
                const role = localStorage.getItem('userRole');
                const endpoint = role === 'admin' ? '/admin/analytics' : '/club/analytics';
                
                const response = await Utils.apiRequest(`${API_BASE_URL}${endpoint}?timeRange=${currentTimeRange}`);
                
                if (response && response.success) {
                    updateKeyMetrics(response.metrics);
                    updateCharts(response.chartData);
                    updateTopEvents(response.topEvents);
                    updateRecentActivity(response.recentActivity);
                    updateEventStatusDistribution(response.statusDistribution);
                } else {
                    throw new Error(response?.message || 'Failed to load analytics data');
                }
            } catch (error) {
                console.error('Error loading analytics:', error);
                Utils.showToast('Error loading analytics data', 'danger');
                showEmptyState();
            }
        }

        // Update key metrics
        function updateKeyMetrics(metrics) {
            document.getElementById('totalEventsMetric').textContent = metrics.totalEvents || 0;
            document.getElementById('totalParticipantsMetric').textContent = metrics.totalParticipants || 0;
            document.getElementById('attendanceRateMetric').textContent = `${metrics.averageAttendanceRate || 0}%`;
            document.getElementById('successRateMetric').textContent = `${metrics.eventSuccessRate || 0}%`;
            
            // Update change indicators
            updateChangeIndicator('eventsChange', metrics.eventsChange);
            updateChangeIndicator('participantsChange', metrics.participantsChange);
            updateChangeIndicator('attendanceChange', metrics.attendanceChange);
            updateChangeIndicator('successChange', metrics.successChange);
        }

        // Update change indicator
        function updateChangeIndicator(elementId, change) {
            const element = document.getElementById(elementId);
            const value = change || 0;
            const isPositive = value >= 0;
            
            element.textContent = `${isPositive ? '+' : ''}${value}% from last period`;
            element.className = isPositive ? 'text-success' : 'text-danger';
        }

        // Update charts
        function updateCharts(chartData) {
            // Update trends chart
            updateTrendsChart('eventsChart', chartData.trends);
            
            // Update categories chart
            updateCategoriesChart(chartData.categories);
        }

        // Update trends chart
        function updateTrendsChart(chartType, trendsData) {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            if (trendsChart) {
                trendsChart.destroy();
            }
            
            let data, label, borderColor, backgroundColor;
            
            switch(chartType) {
                case 'eventsChart':
                    data = trendsData?.events || [];
                    label = 'Events Created';
                    borderColor = '#3b82f6';
                    backgroundColor = 'rgba(59, 130, 246, 0.1)';
                    break;
                case 'registrationsChart':
                    data = trendsData?.registrations || [];
                    label = 'Registrations';
                    borderColor = '#10b981';
                    backgroundColor = 'rgba(16, 185, 129, 0.1)';
                    break;
                case 'attendanceChart':
                    data = trendsData?.attendance || [];
                    label = 'Attendance';
                    borderColor = '#f59e0b';
                    backgroundColor = 'rgba(245, 158, 11, 0.1)';
                    break;
            }
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: generateDateLabels(currentTimeRange),
                    datasets: [{
                        label: label,
                        data: data,
                        borderColor: borderColor,
                        backgroundColor: backgroundColor,
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // Update categories chart
        function updateCategoriesChart(categoriesData) {
            const ctx = document.getElementById('categoriesChart').getContext('2d');
            
            if (categoriesChart) {
                categoriesChart.destroy();
            }
            
            const categories = categoriesData || [];
            const labels = categories.map(cat => cat.category);
            const data = categories.map(cat => cat.count);
            
            categoriesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: [
                            '#3b82f6',
                            '#10b981',
                            '#f59e0b',
                            '#8b5cf6',
                            '#ef4444',
                            '#06b6d4'
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: '#ffffff',
                                usePointStyle: true,
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // Update top events
        function updateTopEvents(topEvents) {
            const container = document.getElementById('topEventsList');
            const loading = document.getElementById('topEventsLoading');
            const noData = document.getElementById('noTopEventsMessage');
            
            loading.style.display = 'none';
            
            if (!topEvents || topEvents.length === 0) {
                noData.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = topEvents.map((event, index) => `
                <div class="d-flex align-items-center p-3 glass-dark rounded-3 mb-3">
                    <div class="me-3">
                        <div class="bg-primary rounded-circle d-flex align-items-center justify-content-center" style="width: 30px; height: 30px;">
                            <span class="text-white fw-bold">${index + 1}</span>
                        </div>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="fw-bold mb-1">${event.eventName}</h6>
                        <small class="text-muted">
                            ${event.registrations} registrations â€¢ ${event.attendanceRate}% attendance
                        </small>
                    </div>
                    <div class="text-end">
                        <div class="badge badge-success">${event.score}/100</div>
                    </div>
                </div>
            `).join('');
        }

        // Update recent activity
        function updateRecentActivity(activities) {
            const container = document.getElementById('activityTimeline');
            const loading = document.getElementById('activityLoading');
            const noData = document.getElementById('noActivityMessage');
            
            loading.style.display = 'none';
            
            if (!activities || activities.length === 0) {
                noData.style.display = 'block';
                return;
            }
            
            container.style.display = 'block';
            container.innerHTML = activities.map(activity => `
                <div class="d-flex align-items-start p-3 glass-dark rounded-3 mb-3">
                    <div class="me-3">
                        <i class="fas ${getActivityIcon(activity.type)} fa-lg" style="color: ${getActivityColor(activity.type)};"></i>
                    </div>
                    <div class="flex-grow-1">
                        <p class="mb-1">${activity.description}</p>
                        <small class="text-muted">${Utils.formatDate(activity.timestamp, 'datetime')}</small>
                    </div>
                </div>
            `).join('');
        }

        // Update event status distribution
        function updateEventStatusDistribution(distribution) {
            if (!distribution) return;
            
            const total = distribution.pending + distribution.approved + distribution.completed + distribution.cancelled;
            
            document.getElementById('pendingEventsCount').textContent = distribution.pending || 0;
            document.getElementById('approvedEventsCount').textContent = distribution.approved || 0;
            document.getElementById('completedEventsCount').textContent = distribution.completed || 0;
            document.getElementById('cancelledEventsCount').textContent = distribution.cancelled || 0;
            
            // Update progress bars
            document.getElementById('pendingProgress').style.width = `${(distribution.pending / total) * 100}%`;
            document.getElementById('approvedProgress').style.width = `${(distribution.approved / total) * 100}%`;
            document.getElementById('completedProgress').style.width = `${(distribution.completed / total) * 100}%`;
            document.getElementById('cancelledProgress').style.width = `${(distribution.cancelled / total) * 100}%`;
        }

        // Helper functions
        function generateDateLabels(days) {
            const labels = [];
            for (let i = days - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            }
            return labels;
        }

        function getActivityIcon(type) {
            switch(type) {
                case 'event_created': return 'fa-plus-circle';
                case 'event_approved': return 'fa-check-circle';
                case 'event_rejected': return 'fa-times-circle';
                case 'registration': return 'fa-user-plus';
                case 'attendance': return 'fa-qrcode';
                default: return 'fa-info-circle';
            }
        }

        function getActivityColor(type) {
            switch(type) {
                case 'event_created': return '#3b82f6';
                case 'event_approved': return '#10b981';
                case 'event_rejected': return '#ef4444';
                case 'registration': return '#f59e0b';
                case 'attendance': return '#8b5cf6';
                default: return '#6b7280';
            }
        }

        // Export analytics data
        async function exportAnalyticsData() {
            try {
                const role = localStorage.getItem('userRole');
                const endpoint = role === 'admin' ? '/admin/analytics/export' : '/club/analytics/export';
                
                const response = await Utils.apiRequest(`${API_BASE_URL}${endpoint}?timeRange=${currentTimeRange}`);
                
                if (response && response.success) {
                    // Create and download CSV file
                    const csvContent = convertToCSV(response.data);
                    const blob = new Blob([csvContent], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `eventsphere-analytics-${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    Utils.showToast('Analytics data exported successfully!', 'success');
                } else {
                    throw new Error('Failed to export data');
                }
            } catch (error) {
                console.error('Error exporting data:', error);
                Utils.showToast('Error exporting analytics data', 'danger');
            }
        }

        // Convert data to CSV format
        function convertToCSV(data) {
            if (!data || !data.length) return '';
            
            const headers = Object.keys(data[0]);
            const csvHeaders = headers.join(',');
            
            const csvRows = data.map(row => {
                return headers.map(header => {
                    const value = row[header];
                    return typeof value === 'string' && value.includes(',') ? `"${value}"` : value;
                }).join(',');
            });
            
            return [csvHeaders, ...csvRows].join('\n');
        }

        // Show empty state
        function showEmptyState() {
            document.getElementById('totalEventsMetric').textContent = '0';
            document.getElementById('totalParticipantsMetric').textContent = '0';
            document.getElementById('attendanceRateMetric').textContent = '0%';
            document.getElementById('successRateMetric').textContent = '0%';
            
            document.getElementById('noTopEventsMessage').style.display = 'block';
            document.getElementById('noActivityMessage').style.display = 'block';
            document.getElementById('topEventsLoading').style.display = 'none';
            document.getElementById('activityLoading').style.display = 'none';
        }
    </script>
</body>
</html>
